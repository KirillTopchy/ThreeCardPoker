<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>3 Card Poker</title>
    <style>
      #messages {
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 100%;
        overflow: auto;
        border: 1px solid #ccc;
        padding: 10px;
      }
      .div-container {
        margin-bottom: 10px;
      }
    </style>
  </head>

  <body>
    <h1>Welcome!</h1>
    <h3 id="balance-text">Your Balance: <span id="balance-value">500</span></h3>
    <div id="clientMessages"></div>
    <div class="div-container">
      <button id="join-button" type="submit">Join game</button>
      <button id="play-button" type="submit" disabled>Play</button>
      <button id="fold-button" type="submit" disabled>Fold</button>
    </div>
    <div class="div-container">
      <label for="bet-field">Bet amount:</label>
      <input type="text" id="bet-field" />
      <button id="place-bet-button" type="submit" disabled>Place Bet</button>
    </div>
    <hr />
    <div id="serverMessages"></div>

    <script>
      const clientMessages = document.getElementById("clientMessages");
      const serverMessages = document.getElementById("serverMessages");
      const joinButton = document.getElementById("join-button");
      const playButton = document.getElementById("play-button");
      const foldButton = document.getElementById("fold-button");
      const betField = document.getElementById("bet-field");
      const placeBetButton = document.getElementById("place-bet-button");
      const ws = new WebSocket("ws://127.0.0.1:9000/poker");

      betField.addEventListener("input", () => {
        const betValue = parseFloat(betField.value);
        if (!isNaN(betValue) && betValue > 0 && betValue < 500) {
          playButton.disabled = false;
          foldButton.disabled = false;
          placeBetButton.disabled = false;
        } else {
          playButton.disabled = true;
          foldButton.disabled = true;
          placeBetButton.disabled = true;
        }
      });

      // add event listener for the WebSocket open event
      ws.addEventListener("open", event => {
        console.log("WebSocket connection opened");
      });

      ws.addEventListener("message", event => {
        const receivedMessage = JSON.parse(event.data);
        const messageModel = receivedMessage.Message.msg;

        console.log(messageModel);

        if (containsCard(messageModel)) {
          const parsedMessageModel = JSON.parse(messageModel);
          const cards = parseCardsToString(parsedMessageModel);
          const combination = parseCardsCombinationToString(parsedMessageModel);

          if (JSON.parse(messageModel).isPlayerHand) {
            serverMessages.innerHTML =
              `<p>Your Hand: ${cards}, Card combination: ${combination}</p>` +
              serverMessages.innerHTML;
            serverMessages.innerHTML =
              `<p>Please make your decision Play/Fold</p>` +
              serverMessages.innerHTML;
          } else {
            serverMessages.innerHTML =
              `<p>Dealer Hand: ${cards}, Card combination: ${combination}</p>` +
              serverMessages.innerHTML;
          }
        } else {
          if (messageModel.includes("Game with id")) {
            const lineSeparator =
              '<p style="width: 100%; border-top: 1px solid black;"></p>';
            serverMessages.innerHTML = lineSeparator + serverMessages.innerHTML;
          }

          gameOutcome = convertGameOutcomeToText(receivedMessage);
          if (gameOutcome.length > 0) {
            const textToshow = "Game outcome: " + gameOutcome;
            serverMessages.innerHTML =
              `<p>${textToshow}</p>` + serverMessages.innerHTML;
          } else {
            serverMessages.innerHTML =
              `<p>${messageModel}</p>` + serverMessages.innerHTML;
          }
        }
      });

      function updateBalanceText() {
        const balanceValueElement = document.getElementById("balance-value");
        balanceValueElement.textContent = balance.toString();
      }

      joinButton.addEventListener("click", event => {
        event.preventDefault();
        ws.send(JSON.stringify({ Join: {} }));
      });

      playButton.addEventListener("click", event => {
        event.preventDefault();
        const betValue = parseFloat(betField.value);

        let message = {
          PlayerDecision: {
            decision: {
              Play: {
                bet: betValue
              }
            }
          }
        };

        ws.send(JSON.stringify(message));
      });

      foldButton.addEventListener("click", event => {
        event.preventDefault();

        let message = {
          PlayerDecision: {
            decision: {
              Fold: {}
            }
          }
        };

        ws.send(JSON.stringify(message));
      });

      placeBetButton.addEventListener("click", event => {
        event.preventDefault();
        const message = betField.value;
        console.log(message);
        serverMessages.innerHTML =
              `<p>You placed Ante Bet: ${message}$</p>` + serverMessages.innerHTML;
        betField.value = "";
        console.log(JSON.stringify({ Bet: { amount: message } }));
        ws.send(JSON.stringify({ Bet: { amount: message } }));
      });

      function parseCardsCombinationToString(json) {
        try {
          const combination = json.combination;
          let combinationString = "";

          if (combination && typeof combination === "object") {
            const combinationName = Object.keys(combination)[0];

            const formattedCombinationName = combinationName
              .replace(/([A-Z])/g, " $1")
              .trim();

            combinationString =
              formattedCombinationName || "Unknown Combination";
          }

          return combinationString;
        } catch (error) {
          return "";
        }
      }

      function convertGameOutcomeToText(json) {
        const jsonString = JSON.stringify(json);

        if (jsonString.includes("folded")) {
          return "";
        }

        if (jsonString.includes("PlayerWon")) {
          return "Player Won";
        }

        if (jsonString.includes("DealerWon")) {
          return "Dealer Won";
        }

        if (jsonString.includes("Tied")) {
          return "Tied";
        }

        return "";
      }

      function parseCardsToString(json) {
        try {
          const parsedCards = json.cards;
          const cardStrings = parsedCards.map(card => {
            const rankValue = card.rank.value;
            const rankSymbol = card.rank.symbol;
            const suitName = card.suit.name;
            return `${rankSymbol}${suitName.charAt(0).toLowerCase()}`;
          });

          return cardStrings.join(", ");
        } catch (error) {
          return "";
        }
      }

      function containsCard(json) {
        try {
          const cards = JSON.parse(json).cards;
          return cards.some(card => {
            const rank = card.rank;
            const suit = card.suit;
            return (
              rank &&
              suit &&
              typeof rank.value === "number" &&
              typeof rank.symbol === "string" &&
              typeof suit.name === "string"
            );
          });
        } catch (error) {
          return false;
        }
      }

      function isPlayerCards(json) {
        const isPlayer = JSON.parse(json).isPlayer;
      }
    </script>
  </body>
</html>
